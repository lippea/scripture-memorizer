<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>简易经文默写</title>
  <style>
    body {
      margin: 0;
      padding: 24px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f7f7f8;
      color: #1f2937;
    }
    .wrap {
      max-width: 760px;
      margin: 0 auto;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 18px;
    }
    h1 {
      margin: 0 0 12px;
      font-size: 22px;
    }
    .hint {
      margin: 10px 0 14px;
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background: #fafafa;
      line-height: 1.6;
    }
    textarea {
      width: 100%;
      min-height: 130px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 10px;
      font-size: 15px;
      line-height: 1.6;
      resize: vertical;
      box-sizing: border-box;
    }
    .row {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    button {
      border: 0;
      border-radius: 8px;
      padding: 9px 13px;
      cursor: pointer;
      font-weight: 600;
      background: #2563eb;
      color: #fff;
    }
    button.secondary {
      background: #6b7280;
    }
    #result {
      margin-top: 12px;
      font-weight: 700;
    }
    .ok {
      color: #047857;
    }
    .bad {
      color: #b91c1c;
    }
    .note {
      margin-top: 10px;
      color: #6b7280;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>简易经文默写</h1>
    <div id="hint" class="hint">加载中...</div>
    <textarea id="answer" placeholder="在这里补全经文"></textarea>
    <div class="row">
      <button id="checkBtn" type="button">检查</button>
      <button id="showBtn" type="button" class="secondary">显示答案</button>
      <button id="nextBtn" type="button">下一题（随机）</button>
    </div>
    <div id="result"></div>
    <div class="note">题型：随机显示经文出处，或经文开头几个字，要求你补全剩余内容。</div>
  </div>

  <script>
    const els = {
      hint: document.getElementById("hint"),
      answer: document.getElementById("answer"),
      result: document.getElementById("result"),
      checkBtn: document.getElementById("checkBtn"),
      showBtn: document.getElementById("showBtn"),
      nextBtn: document.getElementById("nextBtn")
    };

    const state = {
      groups: [],
      verses: [],
      current: null,
      mode: "reference", // "reference" | "prefix"
      prefixText: ""
    };

    function normalize(text) {
      return text
        .toLowerCase()
        .replace(/[^a-z0-9\u4e00-\u9fa5\s]/gi, "")
        .replace(/\s+/g, " ")
        .trim();
    }

    function randomItem(list) {
      return list[Math.floor(Math.random() * list.length)];
    }

    function toGroupName(fileName) {
      return fileName
        .replace(/\.json$/i, "")
        .replace(/^verses[-_]?/i, "")
        .replace(/[-_]+/g, " ")
        .trim() || "未命名分组";
    }

    async function scanVerseGroupFiles() {
      const res = await fetch("./verses/");
      if (!res.ok) throw new Error("scan folder fail");
      const html = await res.text();
      const doc = new DOMParser().parseFromString(html, "text/html");
      const links = Array.from(doc.querySelectorAll("a"));
      const files = links
        .map((a) => decodeURIComponent(a.getAttribute("href") || "").trim())
        .filter((href) => href.toLowerCase().endsWith(".json"))
        .filter((href) => !href.includes("/"))
        .sort();

      if (!files.length) throw new Error("no json file in verses folder");

      return files.map((file) => ({
        name: toGroupName(file),
        file: `verses/${file}`
      }));
    }

    async function loadVersesFromFile(file) {
      const res = await fetch(`./${file}`);
      if (!res.ok) throw new Error(`load fail: ${file}`);
      const data = await res.json();
      if (!Array.isArray(data) || data.length === 0) {
        throw new Error(`empty verses: ${file}`);
      }
      const normalized = data
        .map((item) => {
          const reference = item.reference || item["出处"] || "";
          const text = item.text || item["内容"] || "";
          return {
            reference: String(reference).trim(),
            text: String(text).trim()
          };
        })
        .filter((item) => item.reference && item.text);

      if (normalized.length === 0) {
        throw new Error(`invalid verse format: ${file}`);
      }
      return normalized;
    }

    async function loadAllVerses(groups) {
      const all = [];
      for (const group of groups) {
        const items = await loadVersesFromFile(group.file);
        all.push(...items);
      }
      if (all.length === 0) throw new Error("no verses loaded");
      state.verses = all;
    }

    function newQuestion() {
      if (!state.verses.length) return;
      state.current = randomItem(state.verses);
      state.mode = Math.random() < 0.5 ? "reference" : "prefix";
      state.prefixText = "";

      const verse = state.current;
      const fullText = verse.text.trim();
      const prefixLen = Math.max(6, Math.min(14, Math.floor(fullText.length * 0.2)));

      if (state.mode === "reference") {
        els.hint.textContent = `经文出处：${verse.reference}（请默写完整经文）`;
      } else {
        state.prefixText = fullText.slice(0, prefixLen);
        els.hint.textContent = `经文开头：${state.prefixText}...（请补全后面的内容）`;
      }

      els.answer.value = "";
      els.result.textContent = "";
      els.result.className = "";
      els.answer.focus();
    }

    function isCorrect() {
      const verse = state.current;
      const user = normalize(els.answer.value);
      const full = normalize(verse.text);

      if (!user) return false;

      if (state.mode === "reference") {
        return user === full;
      }

      const remain = normalize(verse.text.slice(state.prefixText.length));
      // 前缀模式：输入剩余内容，或输入整节经文，都算正确
      return user === remain || user === full;
    }

    function checkAnswer() {
      if (!state.current) return;
      if (isCorrect()) {
        els.result.textContent = "正确！";
        els.result.className = "ok";
      } else {
        els.result.textContent = "不完全正确，再试一次或点“显示答案”。";
        els.result.className = "bad";
      }
    }

    function showAnswer() {
      const verse = state.current;
      if (!verse) return;
      els.result.className = "";
      els.result.textContent = `答案：${verse.reference} - ${verse.text}`;
    }

    async function init() {
      try {
        // 优先扫描 verses/ 下的所有 json 文件；失败时回退到 groups.json
        try {
          state.groups = await scanVerseGroupFiles();
        } catch {
          const groupRes = await fetch("./groups.json");
          if (!groupRes.ok) throw new Error("groups load fail");
          state.groups = await groupRes.json();
        }

        if (!Array.isArray(state.groups) || state.groups.length === 0) {
          throw new Error("empty groups");
        }
        await loadAllVerses(state.groups);
        newQuestion();
      } catch (e) {
        els.hint.textContent = "加载失败。请确认 verses/ 下有 json 文件，或提供 groups.json，并在当前目录启动本地服务访问页面。";
        console.error(e);
      }
    }

    els.checkBtn.addEventListener("click", checkAnswer);
    els.showBtn.addEventListener("click", showAnswer);
    els.nextBtn.addEventListener("click", newQuestion);
    els.answer.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && (e.metaKey || e.ctrlKey)) {
        checkAnswer();
      }
    });

    init();
  </script>
</body>
</html>
