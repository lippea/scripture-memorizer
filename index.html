<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>经文默写</title>
  <style>
    body {
      margin: 0;
      padding: 24px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f7f7f8;
      color: #1f2937;
    }
    .wrap {
      max-width: 760px;
      margin: 0 auto;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 18px;
    }
    h1 {
      margin: 0 0 12px;
      font-size: 22px;
    }
    .hint {
      margin: 10px 0 14px;
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background: #fafafa;
      line-height: 1.6;
    }
    .ref-line {
      text-align: center;
      font-weight: 700;
      margin: 2px 0;
    }
    .verse-line {
      margin: 8px 0;
      white-space: pre-wrap;
      word-break: break-word;
      min-height: 56px;
    }
    .verse-line.fill-mode {
      border-bottom: 2px solid #9ca3af;
      padding-bottom: 12px;
      line-height: 1.8;
      outline: none;
      cursor: text;
      position: relative;
    }
    .verse-line.fill-mode:focus {
      border-bottom-color: #2563eb;
    }
    .verse-line.fill-mode::before {
      content: attr(data-placeholder);
      color: #9ca3af;
      opacity: 0.6;
      pointer-events: none;
      position: absolute;
      left: 0;
      top: 6px;
      right: 0;
      white-space: pre-wrap;
      z-index: 0;
    }
    .verse-line.fill-mode.has-input::before {
      opacity: 0.35;
    }
    .verse-line.fill-mode:focus::before {
      opacity: 0.45;
    }
    .row {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    button {
      border: 0;
      border-radius: 8px;
      padding: 9px 13px;
      cursor: pointer;
      font-weight: 600;
      background: #2563eb;
      color: #fff;
    }
    button.secondary {
      background: #6b7280;
    }
    #result {
      margin-top: 12px;
      font-weight: 700;
    }
    .ok {
      color: #047857;
    }
    .bad {
      color: #b91c1c;
    }
    .note {
      margin-top: 10px;
      color: #6b7280;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>经文默写</h1>
    <div id="hint" class="hint">
      <div id="topRef" class="ref-line">加载中...</div>
      <div id="verseLine" class="verse-line"></div>
      <div id="bottomRef" class="ref-line"></div>
    </div>
    <div class="row">
      <button id="checkBtn" type="button">检查</button>
      <button id="showBtn" type="button" class="secondary">显示答案</button>
      <button id="nextBtn" type="button">下一题（随机）</button>
    </div>
    <div id="result"></div>
    <div class="note">题型：随机提示题（显示内容）或默写题（显示横线）。</div>
  </div>

  <script>
    const els = {
      hint: document.getElementById("hint"),
      topRef: document.getElementById("topRef"),
      verseLine: document.getElementById("verseLine"),
      bottomRef: document.getElementById("bottomRef"),
      result: document.getElementById("result"),
      checkBtn: document.getElementById("checkBtn"),
      showBtn: document.getElementById("showBtn"),
      nextBtn: document.getElementById("nextBtn")
    };

    const state = {
      groups: [],
      verses: [],
      current: null,
      mode: "fill" // "fill" | "hint"
    };

    function normalize(text) {
      return text
        .toLowerCase()
        .replace(/[^a-z0-9\u4e00-\u9fa5\s]/gi, "")
        .replace(/\s+/g, " ")
        .trim();
    }

    function randomItem(list) {
      return list[Math.floor(Math.random() * list.length)];
    }

    function toGroupName(fileName) {
      return fileName
        .replace(/\.json$/i, "")
        .replace(/^verses[-_]?/i, "")
        .replace(/[-_]+/g, " ")
        .trim() || "未命名分组";
    }

    async function scanVerseGroupFiles() {
      const res = await fetch("./verses/");
      if (!res.ok) throw new Error("scan folder fail");
      const html = await res.text();
      const doc = new DOMParser().parseFromString(html, "text/html");
      const links = Array.from(doc.querySelectorAll("a"));
      const files = links
        .map((a) => decodeURIComponent(a.getAttribute("href") || "").trim())
        .filter((href) => href.toLowerCase().endsWith(".json"))
        .filter((href) => !href.includes("/"))
        .sort();

      if (!files.length) throw new Error("no json file in verses folder");

      return files.map((file) => ({
        name: toGroupName(file),
        file: `verses/${file}`
      }));
    }

    async function loadVersesFromFile(file) {
      const res = await fetch(`./${file}`);
      if (!res.ok) throw new Error(`load fail: ${file}`);
      const data = await res.json();
      if (!Array.isArray(data) || data.length === 0) {
        throw new Error(`empty verses: ${file}`);
      }
      const normalized = data
        .map((item) => {
          const reference = item.reference || item["出处"] || "";
          const text = item.text || item["内容"] || "";
          return {
            reference: String(reference).trim(),
            text: String(text).trim()
          };
        })
        .filter((item) => item.reference && item.text);

      if (normalized.length === 0) {
        throw new Error(`invalid verse format: ${file}`);
      }
      return normalized;
    }

    async function loadAllVerses(groups) {
      const all = [];
      for (const group of groups) {
        const items = await loadVersesFromFile(group.file);
        all.push(...items);
      }
      if (all.length === 0) throw new Error("no verses loaded");
      state.verses = all;
    }

    function toBlankLine(text) {
      return "_".repeat(Math.max(24, Math.min(120, text.length)));
    }

    function syncFillUnderline() {
      const hasInput = normalize(els.verseLine.textContent).length > 0;
      els.verseLine.classList.toggle("has-input", hasInput);
    }

    function newQuestion() {
      if (!state.verses.length) return;
      state.current = randomItem(state.verses);
      state.mode = Math.random() < 0.5 ? "hint" : "fill";

      const verse = state.current;
      els.topRef.textContent = verse.reference;
      els.bottomRef.textContent = verse.reference;
      if (state.mode === "hint") {
        els.verseLine.classList.remove("fill-mode");
        els.verseLine.classList.remove("has-input");
        els.verseLine.removeAttribute("contenteditable");
        els.verseLine.removeAttribute("data-placeholder");
        els.verseLine.textContent = verse.text;
      } else {
        els.verseLine.classList.add("fill-mode");
        els.verseLine.classList.remove("has-input");
        els.verseLine.setAttribute("contenteditable", "true");
        els.verseLine.setAttribute("data-placeholder", toBlankLine(verse.text));
        els.verseLine.textContent = "";
      }
      els.result.textContent = "";
      els.result.className = "";
      if (state.mode === "fill") els.verseLine.focus();
    }

    function isCorrect() {
      const verse = state.current;
      const user = normalize(els.verseLine.textContent);
      const full = normalize(verse.text);

      if (!user) return false;
      return user === full;
    }

    function checkAnswer() {
      if (!state.current) return;
      if (state.mode === "hint") {
        els.result.textContent = "当前是提示题，直接看经文即可，点“下一题（随机）”进入默写题。";
        els.result.className = "";
        return;
      }
      if (isCorrect()) {
        els.result.textContent = "正确！";
        els.result.className = "ok";
      } else {
        els.result.textContent = "不完全正确，再试一次或点“显示答案”。";
        els.result.className = "bad";
      }
    }

    function showAnswer() {
      const verse = state.current;
      if (!verse) return;
      els.topRef.textContent = verse.reference;
      els.verseLine.classList.remove("fill-mode");
      els.verseLine.classList.remove("has-input");
      els.verseLine.removeAttribute("contenteditable");
      els.verseLine.removeAttribute("data-placeholder");
      els.verseLine.textContent = verse.text;
      els.bottomRef.textContent = verse.reference;
      els.result.className = "";
      els.result.textContent = `答案：${verse.reference} - ${verse.text}`;
    }

    async function init() {
      try {
        // 优先扫描 verses/ 下的所有 json 文件；失败时回退到 groups.json
        try {
          state.groups = await scanVerseGroupFiles();
        } catch {
          const groupRes = await fetch("./groups.json");
          if (!groupRes.ok) throw new Error("groups load fail");
          state.groups = await groupRes.json();
        }

        if (!Array.isArray(state.groups) || state.groups.length === 0) {
          throw new Error("empty groups");
        }
        await loadAllVerses(state.groups);
        newQuestion();
      } catch (e) {
        els.topRef.textContent = "加载失败";
        els.verseLine.textContent = "请确认 verses/ 下有 json 文件，或提供 groups.json，并在当前目录启动本地服务访问页面。";
        els.bottomRef.textContent = "";
        console.error(e);
      }
    }

    els.checkBtn.addEventListener("click", checkAnswer);
    els.showBtn.addEventListener("click", showAnswer);
    els.nextBtn.addEventListener("click", newQuestion);
    els.verseLine.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && (e.metaKey || e.ctrlKey)) {
        checkAnswer();
      }
    });
    els.verseLine.addEventListener("input", syncFillUnderline);

    init();
  </script>
</body>
</html>
